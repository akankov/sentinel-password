import type { Validator, ValidatorOptions } from '../types'

/**
 * Bloom filter for top 1,000 common passwords
 * Sourced from SecLists: https://github.com/danielmiessler/SecLists
 * File: Passwords/Common-Credentials/10k-most-common.txt (top 1000)
 *
 * Uses a Bloom filter for space-efficient storage (~6.6KB vs ~48KB for 10K list)
 * False positive rate: ~0.84%
 * 1,000 passwords checked
 */

// Bloom filter parameters
const BLOOM_SIZE: number = 12000
const BLOOM_HASH_COUNT: number = 7

// Pre-computed bloom filter buckets (375 x 32-bit integers)
const BLOOM_BUCKETS: Int32Array = new Int32Array([
  -1274142440, -1983615455, -2110842727, -1440077142, 1782964852, 956870738, 48445478, 290080800,
  -1961772502, -1869995330, 787111091, 140549329, -1508237141, -800970204, -1987272632, -1439602637,
  1837731885, 240419586, 2143496680, 547359246, -435494235, -1549227926, 151650466, -1742731903,
  -1535043550, -1607849886, -464376123, 1858481975, -1339118942, 410034491, -1397081975, 1217017604,
  -1934873593, -1769402149, -1107107031, -1098029453, 4380674, -393017311, -1465113568, 183557329,
  1713935653, -99073116, 179529869, -1372675933, 78050105, 313074313, -1696462848, 404392594,
  -252409893, -1320442777, -1474295681, -1360120173, -743767380, 135925863, -1462755274, 562596610,
  -483730736, -2002210214, 1803176, 448811114, -1408849403, -735411494, -1872045334, 914538658,
  -374794234, 710617115, -1909840320, -2119695701, -1979682099, -1671944535, -1872492857, 570434164,
  -1334628885, 438020137, -1087528694, 464528967, -359521705, -1407023569, -1759335432, -1181701078,
  -1959746004, -1910872796, 1771191076, -1699312926, -1837137785, 132360706, -1002778102,
  1384163571, 1786784659, -1354832568, -1364547569, -269830616, -1970133308, 848887818, -827577818,
  -1103500629, 2071996096, 1760287282, 1768617098, -1845466197, -1877054343, -223851966,
  -1037686738, 581441802, -761237365, -1282923217, 1328736770, 557363947, 369254184, -1708971466,
  -874268952, -2010768709, -1735196024, -1023761881, 772024867, -328714721, -125771638, 1644593802,
  1762927155, -1509621238, 671919842, -1102294492, -2010455282, 302591302, -2136446493, -1986908626,
  -2018566016, 671347107, 842040354, 243352234, -534627656, -2011035123, -350834429, -844096647,
  -1598189902, -1833872134, -2021613470, -1968994020, -1297357224, 1210222837, -399712104,
  906129314, -1430115578, -2113618941, -906361552, 551676011, 2819256, -1710063476, 1099626796,
  1026172967, 640491579, -1440579096, -1887270648, -1710185214, 1721813836, 984101107, 1944258615,
  724137993, -947645533, 1913070606, 44829860, 101219306, 1011556358, -1432173338, -482828238,
  -2103243204, 447353024, -329610536, 1398671502, 1623196423, 348309551, -211221782, 1980906030,
  778830798, 968125066, -1458011638, -1337934774, 671089894, 52600876, -120418625, -1163255178,
  680202936, -1597565152, 36835260, 1845733400, 153924331, 40509970, 411221088, 2114095983,
  171043813, 1488604610, 172814850, -1702382524, 1502872105, 747635458, -501052624, 411301928,
  731823798, -1333221971, -398552509, 134621864, -1872819037, 1822818465, -1893684382, -1316869470,
  -931632595, -1951260093, 598498019, -1290239178, -989323246, 573220082, 675809232, 169874120,
  -559880256, -910750974, 194548323, 736774690, -719202768, 1814594698, -1155290520, 237063072,
  -488083322, -924144083, 36385696, 715956226, -1568572256, 635709488, 1336062594, 320907784,
  1124501765, -1406433280, -1963307926, -391509877, 1063369670, -1566479450, -1472058776,
  -1985331186, 1377869964, 942987938, 1109713448, 831578699, 853962256, 92835849, 2035317046,
  -2001761759, 216178811, 463827086, 1675819625, -1301764214, -234217277, -1459402461, 579365994,
  -1878875352, -1973245719, -1598478333, 1611084451, 1659513348, -1539122450, 837944629, 154749747,
  -500636954, 1746899746, 714271018, -1150679461, -1538612630, 1814069472, -492197206, -192202641,
  -756936190, -939252957, -1240063770, 1279410916, -1302054220, 1410991882, 1000401066, -198048178,
  -1419228998, -1742550398, -1991360862, -2111688732, -1700640206, 2061912618, -2103274201,
  -288731098, 578232, 53128594, 1755908256, 1116379816, 797411910, -1589060869, -1072342375,
  845812237, 1749465810, 872549054, -1498077050, -1766137746, -376831803, -2084952921, 1202203194,
  1216389770, -1104576382, 818061341, 942317755, -1578565146, 2083914250, -1012266815, 579371193,
  -461075653, 710981226, 1578192039, 681770739, -376523066, 1244735807, -490842006, -781193759,
  556277799, 1984167471, -2000977760, -1265456598, 151665664, -1842697570, 579340290, 1082298021,
  245211512, -1867881849, -1341630964, -90545664, 1806344898, 47088170, 992486842, -1558631407,
  -1449508691, -2006144829, 547374756, 912919200, 708120146, 616106151, 1172449414, 2124751394,
  -2073427929, 1009261122, 1210336770, -1973924734, 144458353, -1155209078, -1962399613, 897229836,
  12357639, -1299101013, 312943930, 708920290, -1310023134, 639040320, -821838839, -2014506238,
  -274610648, -1442508704, 177432331, 1721041571, 414065321, -1272924654, 756208161, 1772773934,
  -1484380630, 1101004848, -1054523758, -2116504793, 1118667297, 86058657, 975856680, 749906058,
  1937961650, 620890537, 918765730, -1366546774,
])

/**
 * Hash function for bloom filter
 */
function hashString(str: string, seed: number): number {
  let hash: number = seed

  for (let i: number = 0; i < str.length; i++) {
    const char: number = str.charCodeAt(i)
    hash = (hash << 5) - hash + char
    hash = hash & hash // Convert to 32-bit integer
  }

  return Math.abs(hash)
}

/**
 * Get multiple hash positions for a password
 */
function getHashes(password: string): number[] {
  const hashes: number[] = []
  const hash1: number = hashString(password, 0)
  const hash2: number = hashString(password, 1)

  for (let i: number = 0; i < BLOOM_HASH_COUNT; i++) {
    const hash: number = (hash1 + i * hash2) >>> 0
    hashes.push(hash % BLOOM_SIZE)
  }

  return hashes
}

/**
 * Check if password might be in the common password list
 * Note: Bloom filters can have false positives (~0.84%) but never false negatives
 */
function mightBeCommon(password: string): boolean {
  const hashes: number[] = getHashes(password.toLowerCase())

  for (const hash of hashes) {
    const arrayIndex: number = Math.floor(hash / 32)
    const bitIndex: number = hash % 32

    // Bounds check for TypeScript strict mode
    const bucket: number | undefined = BLOOM_BUCKETS[arrayIndex]
    if (bucket === undefined || (bucket & (1 << bitIndex)) === 0) {
      return false
    }
  }

  return true
}

/**
 * Validates that a password is not in the common password list
 */
export const validateCommonPassword: Validator = (
  password: string,
  options: ValidatorOptions = {}
) => {
  const { checkCommonPasswords = true }: { checkCommonPasswords?: boolean } = options

  if (!checkCommonPasswords || password.length === 0) {
    return { passed: true }
  }

  // Case-insensitive check using bloom filter
  if (mightBeCommon(password)) {
    return {
      passed: false,
      message: 'Password is too common. Please choose a more unique password.',
    }
  }

  return { passed: true }
}
